# Missing SDK files for Apple LibreSSL

MacOS ships with a modified version of LibreSSL that [uses certs from the MacOS keychain as the CA trust store](https://daniel.haxx.se/blog/2024/03/08/the-apple-curl-security-incident-12604/). Sadly Apple did not upstream these changes, nor provide the required SDK files to link to this library.

This repo has the missing headers and tbd files, generated from the upstream open source repositories. You can use these files to build your own version of curl, with the same dependencies and configuration as [curl included with MacOS](https://github.com/apple-oss-distributions/curl), including support for the keychain CA certs.

## How to use

Either build your project with `-I` and `-L` flags set to the include/lib path of this repo, or point autoconf to the root dir as in the curl example below.

Apple workers [seem to](https://github.com/apple-oss-distributions/curl/blob/main/README.APPLE) store these files under: `$(xcrun --show-sdk-path)/usr/local/libressl`.

## Building curl

Below we build a version of curl only using MacOS libraries, no external dependencies. To build curl as a shared library instead of a standalone command-line `curl` program, remove the `--disable-shared` flag.

As [noted in the Apple readme](https://github.com/apple-oss-distributions/curl/blob/main/README.APPLE), we clean our `PATH` or `PKG_CONFIG_PATH` from other libs that autoconf may pick up on (e.g from homebrew).


```sh
PATH="/bin:/usr/bin/:/usr/local/bin:/usr/sbin"
git clone https://github.com/jeroen/apple-libressl-sdk
SDKFILES="$PWD/apple-libressl-sdk"
curl -OL https://curl.se/download/curl-8.14.1.tar.gz
tar xf curl-8.14.1.tar.gz
cd curl-8.14.1
./configure --enable-threaded-resolver --with-gssapi --with-ssl=$SDKFILES --with-nghttp2=$SDKFILES --with-secure-transport --without-libpsl --disable-shared
make
# make install
```

To confirm that it worked, look at `otool -L` output to see if it libcurl indeed is linked to openssl and nghttp from `/usr/lib`:

```sh
# From the build dir above
./src/curl --version
otool -L ./src/curl
#   /usr/lib/libapple_nghttp2.dylib (compatibility version 1.0.0, current version 1.55.1)
#   /usr/lib/libssl.48.dylib (compatibility version 49.0.0, current version 49.2.0)
#   /usr/lib/libcrypto.46.dylib (compatibility version 47.0.0, current version 47.2.0)
#   /System/Library/Frameworks/Kerberos.framework/Versions/A/Kerberos (compatibility version 5.0.0, current version 6.0.0)
#   /usr/lib/libresolv.9.dylib (compatibility version 1.0.0, current version 1.0.0)
#   /System/Library/Frameworks/LDAP.framework/Versions/A/LDAP (compatibility version 1.0.0, current version 2.4.0)
#   /usr/lib/libz.1.dylib (compatibility version 1.0.0, current version 1.2.12)
#   /System/Library/Frameworks/SystemConfiguration.framework/Versions/A/SystemConfiguration (compatibility version 1.0.0, current version 1351.101.1)
#   /System/Library/Frameworks/Security.framework/Versions/A/Security (compatibility version 1.0.0, current version 61439.101.1)
#   /System/Library/Frameworks/CoreServices.framework/Versions/A/CoreServices (compatibility version 1.0.0, current version 1226.0.0)
#   /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation (compatibility version 150.0.0, current version 3423.0.0)
#   /usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1351.0.0)
```

## Sources

The headers were simply downloaded from upstream sources:

  - [libressl-3.3.6.tar.gz](https://ftp.openbsd.org/pub/OpenBSD/LibreSSL/libressl-3.3.6.tar.gz)
  - [nghttp2-1.55.0.tar.gz](https://github.com/nghttp2/nghttp2/releases/download/v1.55.0/nghttp2-1.55.0.tar.gz)

The `.tbd` (text-based stub) files were generated by first building LibreSSL 3.3.6 from source and then using `tapi stubify` on the shared libraries:

```sh
PATH="/Library/Developer/CommandLineTools/usr/bin/:$PATH"
tapi stubify --filetype=tbd-v4 libcrypto.dylib
tapi stubify --filetype=tbd-v4 libssl.dylib
```

And afterwards the `install-name` and `targets` were manually modified with a text editor.